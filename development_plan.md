# 数据分析可视化工具 - 开发设计文档

## 1. 项目概述

本项目旨在开发一个基于Python的桌面应用程序，用于对特定结构的JSON数据进行可视化分析。工具将使用Tkinter构建图形用户界面（GUI），并利用Pandas库进行高效的数据处理和展示。

该工具的核心功能是加载层级结构的JSON文件，并根据可配置的规则，在界面上清晰地展示单据信息和多维度的数据因子，帮助用户快速理解和分析数据。

## 2. 需求分析

### 2.1. 功能性需求

- **数据导入**: 支持用户选择并导入JSON格式的数据文件。
- **搜索过滤**: 支持对数据表格内容进行搜索过滤，实时显示匹配结果。
- **数据复制**: 支持复制表格单元格值、整行数据为JSON格式，以及字段值的复制功能。
- **可配置UI**:
    - **单据基本信息**: 动态展示JSON文件顶层字段，展示哪些字段应由配置文件决定，支持配置字段对应的中文名称。
    - **因子分类**: 动态展示不同的因子类别（如成本、收入、费用），类别本身可配置。
    - **子因子**: 每个因子分类下可配置多个子因子，支持配置子因子名称的中文显示。
    - **子因子信息**: 动态展示子因子相关的顶层信息，字段可配置，支持字段对应的中文名称显示。
    - **数据表格列**: 动态配置数据表格中需要显示的列，每个因子可以有独立的配置。
    - **数据层次**: 支持配置数据层次的中文名称，并以单选按钮形式展示，优先选择"total"层次。
    - **统一显示名称**: 支持配置字段和因子的统一中文显示名称，在界面上展示更友好的名称。
- **界面布局**:
    - **主界面**: 分为"单据基本信息"和"因子展示"两大区域。
    - **因子展示区**:
        - 以选项卡或类似形式组织不同的因子分类。
        - 每个分类下显示其包含的子因子按钮，显示配置的中文名称。
        - 选中一个子因子后，展示其详细信息。
    - **子因子详情区**:
        - **基本信息**: 显示该子因子的基本字段，使用配置的中文名称。
        - **数据层次**: 使用单选按钮展示`calculateItemVO`中的数据层级（整单 > BOQ > Model > 部件），显示配置的中文名称。
        - **数据表格**: 根据在数据层次中选择的层级，以表格形式展示该层级的所有数据项，列名显示为配置的中文名称。

### 2.2. 技术栈

- **语言**: Python 3.x
- **GUI库**: Tkinter (ttk for modern widgets)
- **数据处理**: Pandas
- **配置文件**: JSON 格式
- **字体**: 微软雅黑 (Microsoft YaHei UI)，提供更好的中文显示效果
- **日志系统**: Python logging模块，支持文件和控制台双重输出
- **内存监控**: psutil库，用于内存使用监控和优化
- **缓存机制**: functools.lru_cache，提供方法级缓存优化
- **垃圾回收**: gc模块，用于大数据集处理时的内存管理

### 2.3. 数据结构

- **输入**: 单一的JSON文件。
- **核心数据**: 位于`calculateItemVO`字段，是一个递归的层级结构。
- **层级标识**: `calcLevel`字段标识当前节点类型（`total`, `boq`, `model`, `part`），支持配置中文显示名称。
- **子节点**: `subList`数组包含下一层级的数据。
- **配置结构**: 
    - `display_names`: 字段名称和因子名称到中文显示名称的统一映射。
    - `data_hierarchy_names`: 数据层次名称到中文显示名称的映射。
    - `factor_configs`: 各因子的特定配置，包括子因子基本信息和数据表格列。

## 3. 系统架构与模块设计

为了实现功能与UI的解耦，我们将采用经典的**Model-View-Controller (MVC)**架构模式。

- **Model (模型)**: 负责数据的加载、解析、处理和存储。它将JSON数据转换为Pandas DataFrame和自定义的数据对象，并处理所有配置信息。
- **View (视图)**: 负责构建和展示用户界面。它包含所有的Tkinter窗口、控件和布局，并从Controller获取要展示的数据。
- **Controller (控制器)**: 作为Model和View之间的桥梁。它响应用户的操作（如点击按钮、选择列表项），调用Model更新数据，并通知View刷新界面。

### 3.1. 项目文件结构

```
calc-any/
│
├── main.py                 # 应用程序主入口
├── config.json             # 配置文件，定义UI展示规则
├── data_model.py           # 数据模型和数据处理逻辑 (Model)
├── view.py                 # UI界面和视图组件 (View)
├── controller.py           # 事件处理和应用逻辑 (Controller)
└── sample.json             # 示例JSON数据文件
```

### 3.2. 模块详细设计

#### `data_model.py` (Model)
- **`ConfigManager` 类**:
    - `load_config(path)`: 加载`config.json`文件，包含文件路径检查和权限验证。
    - `_load_config()`: 私有方法，处理配置文件加载逻辑和异常处理。
    - `_validate_config()`: 私有方法，验证配置文件格式和必要字段。
    - `_load_default_config()`: 私有方法，加载默认配置以确保系统稳定运行。
    - `get_document_info_fields()`: 获取单据基本信息要显示的字段列表。
    - `get_display_name(field)`: 获取字段或因子对应的中文显示名称（合并后的统一方法）。
    - `get_data_hierarchy_name(level)`: 获取数据层次对应的中文显示名称。
    - `get_factor_categories()`: 获取因子分类的配置。
    - `get_sub_factor_basic_info(factor_name)`: 获取子因子基本信息要显示的字段列表，支持因子特定配置。
    - `get_data_table_columns(level, factor_name)`: 根据层级和因子名称获取数据表格要显示的列，支持因子特定配置。
- **`DataManager` 类**:
    - `load_json_data(path)`: 加载并解析JSON数据文件，包含完整的错误处理机制。
    - `_validate_data()`: 私有方法，验证JSON数据结构和必要字段。
    - `get_document_info()`: 提取单据基本信息，包含异常处理。
    - `get_hierarchical_data()`: 提取`calculateItemVO`的层级数据。
    - `get_data_for_level(level_nodes, chunk_size)`: 将指定层级的数据节点转换为Pandas DataFrame，支持大数据集分块处理和内存优化。
    - `_process_large_dataset()`: 私有方法，处理大数据集的分块加载和内存管理。
    - `_optimize_dataframe_memory()`: 私有方法，优化DataFrame的内存使用，包括数据类型优化。
    - `_get_memory_usage()`: 私有方法，监控当前内存使用情况。
    - `get_cached_hierarchy_levels()`: 缓存版本的层次级别获取方法，提升性能。
    - `clear_cache()`: 清理缓存和强制垃圾回收。
    - `get_hierarchy_levels()`: 获取所有数据层次级别。

#### `view.py` (View)
- **`MainAppView` 类**:
    - 初始化主窗口。
    - 创建主布局，使用`ttk.PanedWindow`分割"单据信息"和"因子展示"区域。
    - 实例化`DocumentInfoView`和`FactorView`。
- **`DocumentInfoView` 类**:
    - 创建一个Frame用于展示单据基本信息。
    - `display_info(data, display_names)`: 根据传入的数据和显示名称动态创建并填充`ttk.Label`控件，字段从左到右排列。
- **`FactorView` 类**:
    - 使用`ttk.Notebook`为每个因子分类创建一个选项卡。
    - 在每个选项卡中，使用单选按钮显示子因子，显示配置的中文名称。
- **`SubFactorDetailView` 类**:
    - 布局分为四部分：基本信息、数据层次单选按钮、搜索过滤、数据表格。
    - `display_basic_info(data, display_names)`: 显示子因子的基本信息，使用配置的中文名称，支持右键菜单和双击复制字段值。
    - `setup_data_hierarchy_selection()`: 设置数据层次单选按钮，显示配置的中文名称，优先选择"total"层次。
    - `on_hierarchy_level_select(level)`: 处理数据层次单选按钮的选择事件，并重置搜索框。
    - `display_data_table(dataframe, column_names)`: 使用`ttk.Treeview`作为表格，展示Pandas DataFrame的内容，列名显示为配置的中文名称，支持右键菜单复制行为JSON和双击复制单元格值。
    - `on_search_change()`, `on_search_button_click()`, `on_clear_search()`: 处理搜索框内容变化、搜索按钮点击和清除按钮点击事件。
    - `apply_search_filter()`: 应用搜索过滤，通知控制器过滤数据。
    - `create_context_menu()`, `show_table_context_menu()`, `copy_row_as_json()`, `copy_cell_value()`: 创建和处理表格右键菜单，实现复制功能。
    - `show_field_menu()`, `copy_field_value()`: 处理字段值的右键菜单和复制功能。

#### `controller.py` (Controller)
- **`AppController` 类**:
    - `__init__(model, view)`: 初始化，关联Model和View，配置日志系统。
    - `setup_logging()`: 静态方法，配置应用程序的日志系统，创建logs目录，设置日志格式和输出。
    - `bind_events()`: 绑定所有UI事件，如按钮点击、列表选择等。
    - `load_user_data()`: 响应"导入JSON"按钮，调用Model加载数据，并触发View更新，包含完整的错误处理和日志记录。
    - `on_sub_factor_select()`: 当用户选择一个子因子时，从Model获取数据并更新`SubFactorDetailView`，包含日志记录和错误处理。
    - `on_hierarchy_node_select()`: 当用户选择数据层次单选按钮时，从Model获取对应层级的数据，并更新数据表格，包含完整的日志记录和异常处理。
    - `apply_search_filter()`: 根据搜索文本过滤当前数据帧，并更新表格显示，支持在所有列中搜索，包含日志记录。
    - `refresh_view()`: 刷新视图功能，重新加载配置文件和当前数据，更新界面显示，包含完整的错误处理和日志记录。
    - `reload_config()`: 重新加载配置文件，检测配置变化并记录日志，为refresh_view提供支持。

#### `main.py`
- 应用程序的启动脚本。
- 实例化`DataManager`, `ConfigManager`, `MainAppView`, 和 `AppController`。
- 启动Tkinter的`mainloop()`。

## 4. UI设计草图

- **主窗口**:
    - 顶部是菜单栏，包含“文件”->“导入JSON”。
    - 窗口分为上下两个可拖动调整大小的区域。
- **上半部分 (单据基本信息)**:
    - 一个带标题的Frame。
    - 内部是多行`Key: Value`标签对。
- **下半部分 (因子展示)**:
    - 使用`ttk.Notebook`（选项卡）来显示“成本因子”、“收入因子”等。
    - 每个选项卡内，左侧是一个子因子列表。
    - 右侧是`SubFactorDetailView`，占据大部分空间。
- **子因子详情视图**:
    - 顶部是子因子的`Key: Value`基本信息，支持右键菜单和双击复制字段值。
    - 中间是数据层次的单选按钮组，优先选择"total"层次。
    - 搜索过滤区域，包含搜索框、搜索按钮和清除按钮，支持实时搜索。
    - 底部是数据表格的`ttk.Treeview`，支持右键菜单复制行为JSON和双击复制单元格值。

## 5. 代码质量与系统健壮性

### 5.1. 错误处理与异常管理

- **配置文件处理**: ConfigManager类实现了完整的配置文件加载错误处理，包括文件不存在、权限不足、JSON格式错误等情况的处理，并提供默认配置回退机制。
- **数据文件处理**: DataManager类增强了JSON数据文件的加载和解析错误处理，包括文件读取失败、JSON解析错误、数据结构验证失败等异常情况。
- **用户界面异常**: Controller层添加了完整的用户操作异常处理，确保界面操作不会因为数据问题而崩溃。

### 5.2. 日志系统

- **结构化日志**: 实现了基于Python logging模块的完整日志系统，替代了原有的print语句。
- **多重输出**: 支持同时输出到文件和控制台，日志文件按日期自动分割。
- **日志级别**: 支持不同级别的日志记录（INFO、WARNING、ERROR），便于问题诊断和系统监控。
- **自动目录创建**: 系统启动时自动创建logs目录，确保日志文件能够正常写入。

### 5.3. 内存优化

- **大数据集处理**: 实现了数据分块处理机制，当数据量超过阈值时自动启用分块加载，避免内存溢出。
- **DataFrame优化**: 自动优化Pandas DataFrame的数据类型，包括数值类型降级和字符串类型category化。
- **内存监控**: 集成psutil库实现内存使用监控，实时跟踪内存消耗情况。
- **缓存机制**: 使用LRU缓存优化频繁调用的方法，提升系统响应速度。
- **垃圾回收**: 在大数据处理过程中主动触发垃圾回收，及时释放不再使用的内存。

### 5.4. 输入验证与边界检查

- **参数类型验证**: 为关键方法添加了严格的参数类型检查，确保输入数据的正确性。
- **边界条件处理**: 实现了空数据、无效数据等边界条件的处理逻辑。
- **循环引用检测**: 在处理层级数据时添加了循环引用和递归深度检查，防止无限递归。
- **数据完整性验证**: 在数据加载和处理过程中验证数据结构的完整性和一致性。

### 5.5. 代码结构优化

- **重复代码消除**: 移除了重复的方法定义，统一了命名规范。
- **方法职责明确**: 将复杂方法拆分为多个职责单一的私有方法，提升代码可读性和可维护性。
- **配置统一化**: 合并了字段和因子的显示名称配置，简化了配置文件结构。
- **接口标准化**: 统一了方法接口和返回值格式，提升了代码的一致性。

## 6. 开发计划

开发过程将遵循以下步骤，与待办事项列表保持一致：

1.  **【已完成】编写开发设计Markdown文档**: 明确项目目标和技术路径。
2.  **【已完成】创建项目结构和初始文件**: 建立上文设计的目录结构和空的Python文件。
3.  **【已完成】实现数据加载和配置管理**: 编写`data_model.py`中的`ConfigManager`和`DataManager`的核心功能。
4.  **【已完成】开发Tkinter主界面布局**: 编写`view.py`，搭建出静态的UI框架。
5.  **【已完成】实现单据基本信息展示**: 编写`controller.py`，将加载的数据连接到单据信息视图。
6.  **【已完成】实现因子展示区**: 实现因子分类选项卡和子因子按钮的动态生成，支持中文名称显示。
7.  **【已完成】实现数据层次结构单选按钮**: 将数据层次以单选按钮形式展示，支持中文名称显示。
8.  **【已完成】实现数据表格与Pandas集成**: 将选中层级的数据转换为DataFrame，并显示在表格中，支持列名中文显示。
9.  **【已完成】实现因子特定配置**: 支持每个因子独立配置子因子基本信息和数据表格列，子因子配置可覆盖公共配置。
10. **【已完成】优化界面布局**: 去掉树形结构，只保留单选按钮，优化整体显示效果。
11. **【已完成】合并配置文件中field_display_names和factor_display_names配置**: 将字段和因子的显示名称配置合并为统一的display_names配置，简化配置结构。
12. **【已完成】优化因子切换逻辑**: 默认选择子因子并立即更新详情，优先选择"total"层次以提供更好的用户体验。
13. **【已完成】添加搜索模块**: 支持数据表格过滤功能，实现实时搜索和按钮搜索两种方式。
14. **【已完成】实现表格数据和字段值的复制功能**: 添加右键菜单和双击复制功能，支持复制单元格值和整行数据为JSON格式。
15. **【已完成】调整字体为微软雅黑并优化标题大小**: 统一应用字体样式，优化标题和标签显示效果，提升用户体验。
16. **【已完成】移除程序启动时自动加载示例文件**: 优化用户体验，程序启动时不再自动加载sample.json，改为显示空白的单据基本信息区域。
17. **【已完成】修复单据基本信息样式问题**: 移除单据基本信息区域的提示信息，实现完全空白显示，保持统一的白色背景样式。
18. **【已完成】移除界面边框优化视觉效果**: 移除单据基本信息字段值后的灰色竖线和中括号，通过调整Info.TFrame和Info.TLabel样式实现更简洁的显示效果。
19. **【已完成】优化字体颜色为科技风格**: 将主要文本颜色从深灰色改为纯黑色(#000000)，提升界面对比度和现代科技感，符合专业应用的视觉要求。
20. **【已完成】代码质量优化和系统健壮性提升**: 进行全面的代码分析和优化，包括：
    - **修复ConfigManager路径硬编码问题**: 添加文件路径检查、权限验证和默认配置加载机制
    - **优化DataManager异常处理**: 增强JSON文件加载、解析和数据验证的错误处理
    - **修复UI颜色配置**: 将accent颜色从不合理的黑色改为蓝色，提升用户体验
    - **添加完整日志系统**: 实现结构化日志记录，替代print语句，支持文件和控制台输出
    - **优化代码结构**: 移除重复方法，统一命名规范，提升代码可维护性
    - **增强输入验证**: 添加参数类型验证、边界条件检查和循环引用检测
    - **内存使用优化**: 实现大数据集分块处理、DataFrame内存优化和LRU缓存机制
21. **【已完成】修复控制台AttributeError错误**: 解决菜单中调用refresh_view方法时出现的AttributeError问题：
    - **问题分析**: 菜单中调用了controller.refresh_view()方法，但AppController类中缺少该方法
    - **解决方案**: 在controller.py中添加refresh_view方法，实现配置重载和数据刷新功能
    - **功能实现**: refresh_view方法包含配置重新加载、当前子因子数据刷新、单据基本信息更新等完整流程
    - **错误处理**: 添加完善的异常处理和日志记录，确保刷新操作的稳定性
    - **用户体验**: 菜单中的"刷新"功能现在可以正常工作，提升了应用程序的可用性
22. **【已完成】修复启动时表格字段显示问题**: 解决程序启动时数据表格不显示配置字段和中文名称的问题：
    - **问题分析**: 启动时DataFrame为空，导致display_columns映射为空，表格无法显示配置的字段
    - **视图层优化**: 修改display_data_table方法，支持在无数据时显示配置的列标题
    - **控制器优化**: 修改列名映射逻辑，使用配置的columns而不是df.columns生成显示名称
    - **用户体验**: 启动时即可看到表格结构和中文字段名，无需等待数据加载
    - **功能完善**: 确保空数据和有数据状态下的一致性显示效果
23. **联调、测试和优化**: 完善功能，修复Bug，优化性能。